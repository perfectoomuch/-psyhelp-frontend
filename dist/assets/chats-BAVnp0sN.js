import{_ as b,c as l,o as n,f as o,e as u,k,O as C,b as h,r as x,F as g,j as _,i as y,t as d,n as v,g as $,E as j,h as w,cd as F}from"./index-CQO-ZVad.js";import{u as I}from"./upload.service-DptYWcLn.js";import{e as A}from"./emitUp-BKutWrD2.js";const R={props:["dialogs"],data:()=>({search:""}),computed:{getSearch(){return this.search.trim().length===0?this.dialogs:this.dialogs.filter(t=>t.customer.id==this.search||t.customer.username.includes(this.search)||`${t.customer.first_name.toLowerCase()} ${t.customer.last_name.toLowerCase()}`.includes(this.search.toLowerCase()))}}},z={class:"flex flex-col"},T={key:0,class:"p-2"},q={class:"flex-1 overflow-y-scroll flex flex-col gap-2 px-2 max-h-full"},L={key:0,class:"flex items-center justify-center flex-1 text-center text-sm flex-col px-5 leading-none gap-2"},M={class:"opacity-65"},V=["onClick"],B={class:"card-body flex flex-row gap-2 items-center"},D={class:"min-w-12 h-12 rounded-full uppercase flex items-center justify-center bg-gray-100 border text-md font-semibold group-hover:bg-white"},E={class:"flex flex-col w-[calc(100%-52px)] gap-0.5"},H={class:"flex justify-between"},Y={class:"font-medium"},N=["href"],U={class:"truncate"};function K(t,e,s,r,f,i){const c=x("Icon");return n(),l("div",z,[e[1]||(e[1]=o("div",{class:"flex items-center gap-2 p-4 h-[73px] border-b-[1px]"},[o("h1",{class:"text-2xl font-semibold"},"Диалоги")],-1)),s.dialogs.length>0?(n(),l("div",T,[k(o("input",{type:"text",class:"input focus:outline-none bg-gray-100 rounded-lg",placeholder:"Поиск: id, username, имя, фамилия","onUpdate:modelValue":e[0]||(e[0]=a=>t.search=a)},null,512),[[C,t.search]])])):u("",!0),o("div",q,[i.getSearch.length===0?(n(),l("div",L,[h(c,{name:"Frown",size:44,class:"text-primary"}),o("span",M,[s.dialogs.length===0?(n(),l(g,{key:0},[_("Нет активных диалогов, вернитесь позже")],64)):(n(),l(g,{key:1},[_("Диалог не найден")],64))])])):u("",!0),(n(!0),l(g,null,y(i.getSearch,(a,p)=>{var m;return n(),l("div",{key:p,class:"card bg-base-100 card-sm border cursor-pointer hover:bg-gray-100 group rounded-lg",onClick:Se=>t.$emit("room",a.customer.id)},[o("div",B,[o("div",D,d(Array.from(a.customer.username)[0]),1),o("div",E,[o("div",H,[o("span",Y,d(a.customer.first_name)+" "+d(a.customer.last_name),1),o("a",{href:`https://t.me/${a.customer.username}`,class:"text-primary"}," @"+d(a.customer.username),9,N)]),o("p",U," Сообщение: "+d((m=a.last)==null?void 0:m.message),1)])])],8,V)}),128))])])}const O=b(R,[["render",K]]),P={props:["data","loading"],data:()=>({form:{customer:null,message:"",attachments:[],from:"admin"}}),created(){this.setCustomer()},updated(){this.setCustomer()},methods:{setCustomer(){this.data!==null&&"customer"in this.data&&(this.form.customer=this.data.customer.id)},getFileType(t){const e=[".jpg",".jpeg",".png",".gif",".bmp",".webp"],s=[".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".rtf"],r=t.toLowerCase().split(".").pop();return r?e.includes(`.${r}`)?"photo":s.includes(`.${r}`)?"document":"unknown":"unknown"},openFileChange(){this.$refs.file.click()},async onChangeFile(t){const e=await I(t.target.files[0]);this.form.attachments=[e]},clearAttachments(){this.form.attachments=[]},async onSubmit(){this.form.message.trim().length!==0&&(await A(this,"onAdminMessage",this.form),this.form.message="",this.form.attachments=[])}}},W={class:"w-full h-full flex flex-col"},G={key:0,class:"flex flex-1 items-center justify-center"},J={key:1,class:"flex items-center justify-center flex-1 text-center text-sm flex-col px-5 leading-none gap-2"},Q={key:2,class:"flex flex-col h-full min-h-0 overflow-hidden"},X={class:"h-[73px] flex items-center border-b-[1px]"},Z={class:"text-sm flex flex-row gap-2 items-center px-4 w-full"},ee={class:"min-w-12 h-12 rounded-full uppercase flex items-center justify-center bg-gray-100 border text-md font-semibold group-hover:bg-white"},te={class:"flex flex-col w-[calc(100%-52px)] gap-0.5"},se={class:"flex justify-between"},oe={class:"font-medium"},ae=["href"],ne={id:"messages",class:"flex-1 flex flex-col overflow-y-auto p-4"},le={class:"chat-header"},re={class:"text-xs opacity-50"},ie={class:"chat-bubble text-sm w-fit"},ce=["href"],de=["src"],me=["href"],ue={class:"bg-white w-full border-t-[1px] relative"},he={key:0,class:"flex gap-2 absolute bottom-full p-2 bg-white/50 backdrop-blur-sm w-full"},fe=["src"],ge={class:"flex relative"},pe={class:"flex gap-3 absolute right-2 top-1/2 -translate-y-1/2 z-10"};function xe(t,e,s,r,f,i){const c=x("Icon");return n(),l("div",W,[s.loading&&s.data===null?(n(),l("div",G,e[6]||(e[6]=[o("span",{class:"loading loading-spinner text-primary"},null,-1)]))):u("",!0),s.loading===null&&s.data===null?(n(),l("div",J,[h(c,{name:"MessageSquare",fill:"#0082ce",size:44,class:"text-primary"}),e[7]||(e[7]=o("span",{class:"opacity-65"},"Выберите диалог что бы написать",-1))])):u("",!0),s.loading===!1&&s.data!==null?(n(),l("div",Q,[o("div",X,[o("div",Z,[o("div",ee,d(Array.from(s.data.customer.username)[0]),1),o("div",te,[o("div",se,[o("span",oe,d(s.data.customer.first_name)+" "+d(s.data.customer.last_name),1)]),o("a",{href:`https://t.me/${s.data.customer.username}`,class:"text-primary"}," @"+d(s.data.customer.username),9,ae)]),e[8]||(e[8]=o("button",{class:"btn btn-sm btn-primary"},"Выставить счет",-1))])]),o("div",ne,[(n(!0),l(g,null,y(s.data.chat,(a,p)=>(n(),l("div",{key:p,class:v(["chat w-fit max-w-3/4",[a.from==="customer"?"chat-start":"chat-end ml-auto",p===s.data.chat.length-1?"last_message":""]])},[o("div",le,[a.from==="customer"?(n(),l(g,{key:0},[_(d(s.data.customer.first_name)+" "+d(s.data.customer.last_name),1)],64)):u("",!0),o("time",re,d(t.$dayjs(a.date).format("DD/MM/YYYY HH:mm")),1)]),o("div",ie,[a.attachments.length>0?(n(!0),l(g,{key:0},y(a.attachments,m=>(n(),l("div",{key:m,class:"col-span-2"},[i.getFileType(m)==="photo"?(n(),l("a",{key:0,class:"",href:t.$file(m)},[o("img",{src:t.$file(m),alt:"",class:"rounded-lg"},null,8,de)],8,ce)):(n(),l("a",{key:1,href:t.$file(m),class:"border flex items-center gap-2 text-sm btn btn-primary btn-sm px-7"},[h(c,{name:"File",size:16,class:"min-w-[16px]"}),_(" "+d(m),1)],8,me))]))),128)):u("",!0),o("span",{class:v(["block",[a.attachments.length>0?"mt-2":""]])},d(a.message),3)])],2))),128))]),o("div",ue,[t.form.attachments.length>0?(n(),l("div",he,[(n(!0),l(g,null,y(t.form.attachments,a=>(n(),l("div",{key:a,class:"w-10 h-10 rounded-lg overflow-hidden flex items-center justify-center group relative bg-white border"},[i.getFileType(a)==="photo"?(n(),l("img",{key:0,src:t.$file(a),class:"w-full h-full object-cover",alt:""},null,8,fe)):(n(),$(c,{key:1,name:"FileCheck",size:16})),o("div",{class:"w-full h-full bg-white/60 absolute top-0 left-0 flex items-center justify-center opacity-0 duration-300 group-hover:opacity-100 cursor-pointer",onClick:e[0]||(e[0]=(...p)=>i.clearAttachments&&i.clearAttachments(...p))},[h(c,{name:"Trash",size:16,class:"text-red-400"})])]))),128))])):u("",!0),o("div",ge,[k(o("input",{type:"text",class:"input focus:outline-none bg-gray-100 rounded-none w-full h-[50px] pr-15",placeholder:"Ваше сообщение","onUpdate:modelValue":e[1]||(e[1]=a=>t.form.message=a),onKeyup:e[2]||(e[2]=j((...a)=>i.onSubmit&&i.onSubmit(...a),["enter"]))},null,544),[[C,t.form.message]]),o("div",pe,[o("input",{type:"file",ref:"file",class:"hidden",onChange:e[3]||(e[3]=(...a)=>i.onChangeFile&&i.onChangeFile(...a))},null,544),o("button",{class:"btn border-none bg-white btn-square",onClick:e[4]||(e[4]=(...a)=>i.openFileChange&&i.openFileChange(...a))},[h(c,{name:"Paperclip",size:16})]),o("button",{class:"btn btn-primary btn-square",onClick:e[5]||(e[5]=(...a)=>i.onSubmit&&i.onSubmit(...a))},[h(c,{name:"SendHorizontal",fill:"#ffffff",strokeWidth:0,size:16})])])])])])):u("",!0)])}const ye=b(P,[["render",xe]]);class S{async getAll(){try{return(await w.get("admin/chats")).data}catch(e){console.log(e)}}async getByCustomer(e){try{return(await w.get(`admin/chats/${e}`)).data}catch(s){console.log(s)}}async sendMessage(e,s){try{const r=await w.post(`admin/chats/${e}`,s);return console.log(r.data),r.data}catch(r){console.log(r)}}}const _e={props:["chats"],components:{Sidebar:O,Room:ye},data:()=>({chatService:new S,dialogs:[],room:{loading:null,data:null}}),async created(){var t,e;if(this.dialogs=this.chats,(t=this.$route.query)!=null&&t.customer){const s=this.$route.query.customer;this.dialogs.findIndex(f=>f.customer.id===s)>-1?await this.onChangeRoom((e=this.$route.query)==null?void 0:e.customer):this.$toast.info("Чат с пользователем не найден")}},mounted(){F.on("message",async t=>{console.log(t),this.updateDialog(t.id,t.message),await this.updateRoom(t.customer_id)})},computed:{},methods:{async onChangeRoom(t,e=!0){e&&(this.room.loading=!0);const s=await this.chatService.getByCustomer(t);this.room.data=s,this.room.loading=!1,this.$nextTick(()=>{if(e){const r=document.getElementById("messages");r.scrollTo(0,r.scrollHeight)}else document.querySelector(".last_message").scrollIntoView({behavior:"smooth"})})},async onAdminMessage(t){var i;const e=t.customer,s=t;delete s.customer;const r=await this.chatService.sendMessage(e,s),f=this.chats.findIndex(c=>c.id===r.id);this.dialogs[f].last=r.last,r.id===((i=this.room.data)==null?void 0:i.id)&&(this.room.data=r,this.$nextTick(()=>{document.querySelector(".last_message").scrollIntoView({behavior:"smooth"})}))},updateDialog(t,e){const s=this.dialogs.findIndex(r=>r.id===t);s>-1&&(this.dialogs[s].last=e)},async updateRoom(t){var e;t===((e=this.room.data)==null?void 0:e.customer.id)&&await this.onChangeRoom(t,!1)}}},be={class:"flex w-full h-full"};function we(t,e,s,r,f,i){const c=x("Sidebar"),a=x("Room");return n(),l("div",be,[h(c,{dialogs:t.dialogs,class:"min-w-[340px] max-w-[340px] border-r-[1px]",onRoom:i.onChangeRoom},null,8,["dialogs","onRoom"]),h(a,{class:"w-full",data:t.room.data,loading:t.room.loading},null,8,["data","loading"])])}const ve=b(_e,[["render",we]]),ke={components:{ChatLayout:ve},data:()=>({chatService:new S,chats:[],loading:!0}),created(){this.getAll()},methods:{async getAll(){const t=await this.chatService.getAll();this.chats=t,this.loading=!1}}},Ce={key:0,class:"flex justify-center"};function $e(t,e,s,r,f,i){const c=x("ChatLayout");return t.loading?(n(),l("div",Ce,e[0]||(e[0]=[o("span",{class:"loading loading-spinner text-primary"},null,-1)]))):(n(),$(c,{key:1,chats:t.chats},null,8,["chats"]))}const Ae=b(ke,[["render",$e]]);export{Ae as default};
