import{_,c as r,o as n,f as s,e as m,b as u,r as x,F as p,i as y,t as d,n as w,j as v,g as k,k as $,O as S,E as j,h as b,cd as F}from"./index-CqT2QNuy.js";import{u as A}from"./upload.service-Dnt6nKun.js";import{e as I}from"./emitUp-BKutWrD2.js";const z={props:["dialogs"]},R={class:"flex flex-col"},M={key:0,class:"p-2"},T={class:"flex-1 overflow-y-scroll flex flex-col px-2 max-h-full"},B={key:0,class:"flex items-center justify-center flex-1 text-center text-sm flex-col px-5 leading-none gap-2"},D=["onClick"],E={class:"card-body flex flex-row gap-2 items-center"},V={class:"min-w-12 h-12 rounded-full uppercase flex items-center justify-center bg-gray-100 border text-md font-semibold group-hover:bg-white"},L={class:"flex flex-col w-[calc(100%-52px)] gap-0.5"},q={class:"flex justify-between"},H={class:"font-medium"},Y=["href"],N={class:"truncate"};function K(t,e,o,l,g,i){const c=x("Icon");return n(),r("div",R,[e[2]||(e[2]=s("div",{class:"flex items-center gap-2 p-4 h-[73px] border-b-[1px]"},[s("h1",{class:"text-2xl font-semibold"},"Диалоги")],-1)),o.dialogs.length>0?(n(),r("div",M,e[0]||(e[0]=[s("input",{type:"text",class:"input focus:outline-none bg-gray-100 rounded-lg",placeholder:"Поиск: id, клиент, имя"},null,-1)]))):m("",!0),s("div",T,[o.dialogs.length===0?(n(),r("div",B,[u(c,{name:"Frown",size:44,class:"text-primary"}),e[1]||(e[1]=s("span",{class:"opacity-65"},"Нет активных диалогов, вернитесь позже",-1))])):m("",!0),(n(!0),r(p,null,y(o.dialogs,(a,f)=>(n(),r("div",{key:f,class:"card bg-base-100 card-sm border cursor-pointer hover:bg-gray-100 group rounded-lg",onClick:h=>t.$emit("room",a.customer.id)},[s("div",E,[s("div",V,d(Array.from(a.customer.username)[0]),1),s("div",L,[s("div",q,[s("span",H,d(a.customer.first_name)+" "+d(a.customer.last_name),1),s("a",{href:`https://t.me/${a.customer.username}`,class:"text-primary"}," @"+d(a.customer.username),9,Y)]),s("p",N," Сообщение: "+d(a.last.message),1)])])],8,D))),128))])])}const U=_(z,[["render",K]]),O={props:["data","loading"],data:()=>({form:{customer:null,message:"",attachments:[],from:"admin"}}),created(){this.setCustomer()},updated(){this.setCustomer()},methods:{setCustomer(){this.data!==null&&"customer"in this.data&&(this.form.customer=this.data.customer.id)},getFileType(t){const e=[".jpg",".jpeg",".png",".gif",".bmp",".webp"],o=[".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".rtf"],l=t.toLowerCase().split(".").pop();return l?e.includes(`.${l}`)?"photo":o.includes(`.${l}`)?"document":"unknown":"unknown"},openFileChange(){this.$refs.file.click()},async onChangeFile(t){const e=await A(t.target.files[0]);this.form.attachments=[e]},clearAttachments(){this.form.attachments=[]},async onSubmit(){this.form.message.trim().length!==0&&(await I(this,"onAdminMessage",this.form),this.form.message="",this.form.attachments=[])}}},P={class:"w-full h-full flex flex-col"},W={key:0,class:"flex flex-1 items-center justify-center"},G={key:1,class:"flex items-center justify-center flex-1 text-center text-sm flex-col px-5 leading-none gap-2"},J={key:2,class:"flex flex-col h-full min-h-0 overflow-hidden"},Q={class:"h-[73px] flex items-center border-b-[1px]"},X={class:"text-sm flex flex-row gap-2 items-center px-4 w-full"},Z={class:"min-w-12 h-12 rounded-full uppercase flex items-center justify-center bg-gray-100 border text-md font-semibold group-hover:bg-white"},ee={class:"flex flex-col w-[calc(100%-52px)] gap-0.5"},te={class:"flex justify-between"},se={class:"font-medium"},oe=["href"],ae={id:"messages",class:"flex-1 flex flex-col overflow-y-auto p-4"},ne={class:"chat-header"},le={class:"text-xs opacity-50"},re={class:"chat-bubble text-sm w-fit"},ie=["href"],ce=["src"],de=["href"],me={class:"bg-white w-full border-t-[1px] relative"},ue={key:0,class:"flex gap-2 absolute bottom-full p-2 bg-white/50 backdrop-blur-sm w-full"},he=["src"],fe={class:"flex relative"},ge={class:"flex gap-3 absolute right-2 top-1/2 -translate-y-1/2 z-10"};function pe(t,e,o,l,g,i){const c=x("Icon");return n(),r("div",P,[o.loading&&o.data===null?(n(),r("div",W,e[6]||(e[6]=[s("span",{class:"loading loading-spinner text-primary"},null,-1)]))):m("",!0),o.loading===null&&o.data===null?(n(),r("div",G,[u(c,{name:"MessageSquare",fill:"#0082ce",size:44,class:"text-primary"}),e[7]||(e[7]=s("span",{class:"opacity-65"},"Выберите диалог что бы написать",-1))])):m("",!0),o.loading===!1&&o.data!==null?(n(),r("div",J,[s("div",Q,[s("div",X,[s("div",Z,d(Array.from(o.data.customer.username)[0]),1),s("div",ee,[s("div",te,[s("span",se,d(o.data.customer.first_name)+" "+d(o.data.customer.last_name),1)]),s("a",{href:`https://t.me/${o.data.customer.username}`,class:"text-primary"}," @"+d(o.data.customer.username),9,oe)]),e[8]||(e[8]=s("button",{class:"btn btn-sm btn-primary"},"Выставить счет",-1))])]),s("div",ae,[(n(!0),r(p,null,y(o.data.chat,(a,f)=>(n(),r("div",{key:f,class:w(["chat w-fit max-w-3/4",[a.from==="customer"?"chat-start":"chat-end ml-auto",f===o.data.chat.length-1?"last_message":""]])},[s("div",ne,[a.from==="customer"?(n(),r(p,{key:0},[v(d(o.data.customer.first_name)+" "+d(o.data.customer.last_name),1)],64)):m("",!0),s("time",le,d(t.$dayjs(a.date).format("DD/MM/YYYY HH:mm")),1)]),s("div",re,[a.attachments.length>0?(n(!0),r(p,{key:0},y(a.attachments,h=>(n(),r("div",{key:h,class:"col-span-2"},[i.getFileType(h)==="photo"?(n(),r("a",{key:0,class:"",href:t.$file(h)},[s("img",{src:t.$file(h),alt:"",class:"rounded-lg"},null,8,ce)],8,ie)):(n(),r("a",{key:1,href:t.$file(h),class:"border flex items-center gap-2 text-sm btn btn-primary btn-sm px-7"},[u(c,{name:"File",size:16,class:"min-w-[16px]"}),v(" "+d(h),1)],8,de))]))),128)):m("",!0),s("span",{class:w(["block",[a.attachments.length>0?"mt-2":""]])},d(a.message),3)])],2))),128))]),s("div",me,[t.form.attachments.length>0?(n(),r("div",ue,[(n(!0),r(p,null,y(t.form.attachments,a=>(n(),r("div",{key:a,class:"w-10 h-10 rounded-lg overflow-hidden flex items-center justify-center group relative bg-white border"},[i.getFileType(a)==="photo"?(n(),r("img",{key:0,src:t.$file(a),class:"w-full h-full object-cover",alt:""},null,8,he)):(n(),k(c,{key:1,name:"FileCheck",size:16})),s("div",{class:"w-full h-full bg-white/60 absolute top-0 left-0 flex items-center justify-center opacity-0 duration-300 group-hover:opacity-100 cursor-pointer",onClick:e[0]||(e[0]=(...f)=>i.clearAttachments&&i.clearAttachments(...f))},[u(c,{name:"Trash",size:16,class:"text-red-400"})])]))),128))])):m("",!0),s("div",fe,[$(s("input",{type:"text",class:"input focus:outline-none bg-gray-100 rounded-none w-full h-[50px] pr-15",placeholder:"Ваше сообщение","onUpdate:modelValue":e[1]||(e[1]=a=>t.form.message=a),onKeyup:e[2]||(e[2]=j((...a)=>i.onSubmit&&i.onSubmit(...a),["enter"]))},null,544),[[S,t.form.message]]),s("div",ge,[s("input",{type:"file",ref:"file",class:"hidden",onChange:e[3]||(e[3]=(...a)=>i.onChangeFile&&i.onChangeFile(...a))},null,544),s("button",{class:"btn border-none bg-white btn-square",onClick:e[4]||(e[4]=(...a)=>i.openFileChange&&i.openFileChange(...a))},[u(c,{name:"Paperclip",size:16})]),s("button",{class:"btn btn-primary btn-square",onClick:e[5]||(e[5]=(...a)=>i.onSubmit&&i.onSubmit(...a))},[u(c,{name:"SendHorizontal",fill:"#ffffff",strokeWidth:0,size:16})])])])])])):m("",!0)])}const xe=_(O,[["render",pe]]);class C{async getAll(){try{return(await b.get("admin/chats")).data}catch(e){console.log(e)}}async getByCustomer(e){try{return(await b.get(`admin/chats/${e}`)).data}catch(o){console.log(o)}}async sendMessage(e,o){try{const l=await b.post(`admin/chats/${e}`,o);return console.log(l.data),l.data}catch(l){console.log(l)}}}const ye={props:["chats"],components:{Sidebar:U,Room:xe},data:()=>({chatService:new C,dialogs:[],room:{loading:null,data:null}}),created(){this.dialogs=this.chats},mounted(){F.on("message",async t=>{console.log(t),this.updateDialog(t.id,t.message),await this.updateRoom(t.customer_id)})},computed:{},methods:{async onChangeRoom(t,e=!0){e&&(this.room.loading=!0);const o=await this.chatService.getByCustomer(t);this.room.data=o,this.room.loading=!1,this.$nextTick(()=>{if(e){const l=document.getElementById("messages");l.scrollTo(0,l.scrollHeight)}else document.querySelector(".last_message").scrollIntoView({behavior:"smooth"})})},async onAdminMessage(t){var i;const e=t.customer,o=t;delete o.customer;const l=await this.chatService.sendMessage(e,o),g=this.chats.findIndex(c=>c.id===l.id);this.dialogs[g].last=l.last,l.id===((i=this.room.data)==null?void 0:i.id)&&(this.room.data=l)},updateDialog(t,e){const o=this.dialogs.findIndex(l=>l.id===t);this.dialogs[o].last=e},async updateRoom(t){var e;t===((e=this.room.data)==null?void 0:e.customer.id)&&await this.onChangeRoom(t,!1)}}},_e={class:"flex w-full h-full"};function be(t,e,o,l,g,i){const c=x("Sidebar"),a=x("Room");return n(),r("div",_e,[u(c,{dialogs:t.dialogs,class:"min-w-[340px] max-w-[340px] border-r-[1px]",onRoom:i.onChangeRoom},null,8,["dialogs","onRoom"]),u(a,{class:"w-full",data:t.room.data,loading:t.room.loading},null,8,["data","loading"])])}const we=_(ye,[["render",be]]),ve={components:{ChatLayout:we},data:()=>({chatService:new C,chats:[],loading:!0}),created(){this.getAll()},methods:{async getAll(){const t=await this.chatService.getAll();this.chats=t,this.loading=!1}}},ke={key:0,class:"flex justify-center"};function Ce(t,e,o,l,g,i){const c=x("ChatLayout");return t.loading?(n(),r("div",ke,e[0]||(e[0]=[s("span",{class:"loading loading-spinner text-primary"},null,-1)]))):(n(),k(c,{key:1,chats:t.chats},null,8,["chats"]))}const Fe=_(ve,[["render",Ce]]);export{Fe as default};
