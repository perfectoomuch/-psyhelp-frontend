import{_ as w,c as l,o as n,e as s,g as f,j as F,l as A,b as p,r as _,F as m,q as h,i as b,t as c,h as k,n as C,w as R,f as D,H as z,al as q}from"./index-BeL3-aS9.js";import{u as T}from"./upload.service-BaO_GES9.js";import{e as V}from"./emitUp-BKutWrD2.js";import{I as B}from"./InvoiceDialog-CLuu8qyP.js";import{s as L}from"./transaction-D_hQjA16.js";import"./DialogTrigger.vue_vue_type_script_setup_true_lang-CF3HXNgN.js";import"./utils-SVaxs_O8.js";import"./PopoverTrigger.vue_vue_type_script_setup_true_lang-CH8885Tq.js";import"./transaction.service-DYMrOKFZ.js";import"./specialist.service-Q-smWPwj.js";const M={props:["dialogs"],data:()=>({search:""}),computed:{getSearch(){let t=[];return this.search.trim().length===0?t=this.dialogs:t=this.dialogs.filter(e=>{var o,r,g;return e.customer?e.customer.id==this.search||((o=e.customer.username)==null?void 0:o.includes(this.search))||`${(r=e.customer.first_name)==null?void 0:r.toLowerCase()} ${(g=e.customer.last_name)==null?void 0:g.toLowerCase()}`.includes(this.search.toLowerCase()):!1}),t}}},U={class:"flex flex-col"},E={key:0,class:"p-2"},H={class:"flex-1 overflow-y-scroll flex flex-col gap-2 px-2 max-h-full"},Y={key:0,class:"flex items-center justify-center flex-1 text-center text-sm flex-col px-5 leading-none gap-2"},N={class:"opacity-65"},O=["onClick"],K={class:"card-body flex flex-row gap-2 items-center"},P={class:"min-w-12 h-12 rounded-full uppercase flex items-center justify-center bg-gray-100 border text-md font-semibold group-hover:bg-white"},W={class:"flex flex-col w-[calc(100%-52px)] gap-0.5"},G={class:"flex justify-between"},J={class:"font-medium"},Q=["href"],X={key:1},Z={class:"truncate"};function ee(t,e,o,r,g,i){const u=_("Icon");return n(),l("div",U,[e[2]||(e[2]=s("div",{class:"flex items-center gap-2 p-4 h-[73px] border-b-[1px]"},[s("h1",{class:"text-2xl font-semibold"},"Диалоги")],-1)),o.dialogs.length>0?(n(),l("div",E,[F(s("input",{type:"text",class:"input focus:outline-none bg-gray-100 rounded-lg",placeholder:"Поиск: id, username, имя, фамилия","onUpdate:modelValue":e[0]||(e[0]=d=>t.search=d)},null,512),[[A,t.search]])])):f("",!0),s("div",H,[i.getSearch.length===0?(n(),l("div",Y,[p(u,{name:"Frown",size:44,class:"text-primary"}),s("span",N,[o.dialogs.length===0?(n(),l(m,{key:0},[h("Нет активных диалогов, вернитесь позже")],64)):(n(),l(m,{key:1},[h("Диалог не найден")],64))])])):f("",!0),(n(!0),l(m,null,b(i.getSearch,(d,v)=>{var a,x,y,I,S,j;return n(),l("div",{key:v,class:"card bg-base-100 card-sm border cursor-pointer hover:bg-gray-100 group rounded-lg",onClick:Ue=>t.$emit("room",d.customer.id)},[s("div",K,[s("div",P,[((a=d.customer)==null?void 0:a.username)??!1?(n(),l(m,{key:0},[h(c(Array.from(d.customer.username)[0]),1)],64)):(n(),l(m,{key:1},[h("-")],64))]),s("div",W,[s("div",G,[s("span",J,c(((x=d.customer)==null?void 0:x.first_name)??"")+" "+c(((y=d.customer)==null?void 0:y.last_name)??""),1),((I=d.customer)==null?void 0:I.username)??!1?(n(),l("a",{key:0,href:`https://t.me/${d.customer.username}`,class:"text-primary"}," @"+c(d.customer.username),9,Q)):(n(),l("span",X,"username отсутствует"))]),s("p",Z,[e[1]||(e[1]=h(" Сообщение: ")),(S=d.last)!=null&&S.transaction?(n(),l(m,{key:0},[h("Выставлен счет")],64)):(n(),l(m,{key:1},[h(c((j=d.last)==null?void 0:j.message),1)],64))])])])],8,O)}),128))])])}const te=w(M,[["render",ee]]);class ${async getAll(){try{return(await k.get("admin/chats")).data}catch(e){console.log(e)}}async getByCustomer(e){try{return(await k.get(`admin/chats/${e}`)).data}catch(o){console.log(o)}}async sendMessage(e,o){try{const r=await k.post(`admin/chats/${e}`,o);return console.log(r.data),r.data}catch(r){console.log(r)}}}const se={props:["data","loading"],components:{InvoiceDialog:B},data:()=>({chatService:new $,status:L,form:{customer:null,message:"",attachments:[],from:"admin"}}),created(){this.setCustomer()},updated(){this.setCustomer()},methods:{setCustomer(){this.data!==null&&"customer"in this.data&&(this.form.customer=this.data.customer.id)},getFileType(t){const e=[".jpg",".jpeg",".png",".gif",".bmp",".webp"],o=[".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".rtf"],r=t.toLowerCase().split(".").pop();return r?e.includes(`.${r}`)?"photo":o.includes(`.${r}`)?"document":"unknown":"unknown"},openFileChange(){this.$refs.file.click()},async onChangeFile(t){const e=await T(t.target.files[0]);this.form.attachments=[e]},clearAttachments(){this.form.attachments=[]},async onSubmit(){this.form.message.trim().length!==0&&(await V(this,"onAdminMessage",this.form),this.form.message="",this.form.attachments=[])},onOpenInvoice(){this.$refs.invoiceDialog.openAction(!0,{customer:this.data.customer})},async onInvoiceUpdate(){window.open(`/admin/dashboard/chats?customer=${this.data.customer.id}`,"_self")}}},ae={class:"w-full h-full flex flex-col"},oe={key:0,class:"flex flex-1 items-center justify-center"},ne={key:1,class:"flex items-center justify-center flex-1 text-center text-sm flex-col px-5 leading-none gap-2"},le={key:2,class:"flex flex-col h-full min-h-0 overflow-hidden"},re={class:"h-[73px] flex items-center border-b-[1px]"},ie={class:"text-sm flex flex-row gap-2 items-center px-4 w-full"},ce={class:"min-w-12 h-12 rounded-full uppercase flex items-center justify-center bg-gray-100 border text-md font-semibold group-hover:bg-white"},de={class:"flex flex-col w-[calc(100%-52px)] gap-0.5"},ue={class:"flex justify-between"},me={class:"font-medium"},he=["href"],fe={id:"messages",class:"flex-1 flex flex-col overflow-y-auto p-4"},ge={class:"chat-header"},pe={class:"text-xs opacity-50"},ye=["href"],xe=["src"],_e=["href"],be={key:2,class:"flex flex-col text-white"},we={class:"mb-1 whitespace-normal text-wrap whitespace-normal break-words"},ve={class:"flex flex-col gap-1 whitespace-nowrap"},ke={class:"grid grid-cols-2 gap-2"},Ce={class:"grid grid-cols-2 gap-2"},$e={class:"grid grid-cols-2 gap-2"},Ie={class:"bg-white w-full border-t-[1px] relative"},Se={key:0,class:"flex gap-2 absolute bottom-full p-2 bg-white/50 backdrop-blur-sm w-full"},je=["src"],Fe={class:"flex relative"},Ae={class:"flex gap-3 absolute right-2 top-1/2 -translate-y-1/2 z-10"};function De(t,e,o,r,g,i){const u=_("Icon"),d=_("router-link"),v=_("InvoiceDialog");return n(),l(m,null,[s("div",ae,[o.loading&&o.data===null?(n(),l("div",oe,e[7]||(e[7]=[s("span",{class:"loading loading-spinner text-primary"},null,-1)]))):f("",!0),o.loading===null&&o.data===null?(n(),l("div",ne,[p(u,{name:"MessageSquare",fill:"#0082ce",size:44,class:"text-primary"}),e[8]||(e[8]=s("span",{class:"opacity-65"},"Выберите диалог что бы написать",-1))])):f("",!0),o.loading===!1&&o.data!==null?(n(),l("div",le,[s("div",re,[s("div",ie,[s("div",ce,c(Array.from(o.data.customer.username)[0]),1),s("div",de,[s("div",ue,[s("span",me,c(o.data.customer.first_name)+" "+c(o.data.customer.last_name),1)]),s("a",{href:`https://t.me/${o.data.customer.username}`,class:"text-primary"}," @"+c(o.data.customer.username),9,he)]),s("button",{class:"btn btn-sm btn-primary",onClick:e[0]||(e[0]=(...a)=>i.onOpenInvoice&&i.onOpenInvoice(...a))}," Выставить счет ")])]),s("div",fe,[(n(!0),l(m,null,b(o.data.chat,(a,x)=>(n(),l("div",{key:x,class:C(["chat w-fit max-w-3/4",[a.from==="customer"?"chat-start":"chat-end ml-auto",x===o.data.chat.length-1?"last_message":""]])},[s("div",ge,[a.from==="customer"?(n(),l(m,{key:0},[h(c(o.data.customer.first_name)+" "+c(o.data.customer.last_name),1)],64)):f("",!0),"transaction"in a?(n(),l(m,{key:1},[h(" Выставлен счет на оплату ")],64)):f("",!0),s("time",pe,c(t.$dayjs(a.date).format("DD/MM/YYYY HH:mm")),1)]),s("div",{class:C(["chat-bubble text-sm w-fit",["transaction"in a&&"bg-primary"]])},[a.attachments.length>0?(n(!0),l(m,{key:0},b(a.attachments,y=>(n(),l("div",{key:y,class:"col-span-2"},[i.getFileType(y)==="photo"?(n(),l("a",{key:0,class:"",href:t.$file(y)},[s("img",{src:t.$file(y),alt:"",class:"rounded-lg"},null,8,xe)],8,ye)):(n(),l("a",{key:1,href:t.$file(y),class:"border flex items-center gap-2 text-sm btn btn-primary btn-sm px-7"},[p(u,{name:"File",size:16,class:"min-w-[16px]"}),h(" "+c(y),1)],8,_e))]))),128)):f("",!0),a!=null&&a.transaction?f("",!0):(n(),l("span",{key:1,class:C(["block",[a.attachments.length>0?"mt-2":""]])},c(a.message),3)),a!=null&&a.transaction&&a.transaction.specialist?(n(),l("div",be,[s("p",we,[h(" ID: "+c(a.transaction.id)+" ",1),e[9]||(e[9]=s("br",null,null,-1)),e[10]||(e[10]=s("br",null,null,-1)),h(" "+c(a.transaction.message),1)]),s("div",ve,[s("div",ke,[e[11]||(e[11]=s("span",null,"Специалист:",-1)),p(d,{to:`/admin/dashboard/specialists/${a.transaction.specialist.id}`,class:"text-white underline"},{default:R(()=>[h(c(a.transaction.specialist.first_name)+" "+c(a.transaction.specialist.last_name),1)]),_:2},1032,["to"])]),s("div",Ce,[e[12]||(e[12]=s("span",null,"Сумма:",-1)),s("span",null,c(t.$currency(a.transaction.total)),1)]),s("div",$e,[e[13]||(e[13]=s("span",null,"Статус:",-1)),s("span",null,c(t.status(a.transaction.status).getStatusByValue.name),1)])])])):f("",!0)],2)],2))),128))]),s("div",Ie,[t.form.attachments.length>0?(n(),l("div",Se,[(n(!0),l(m,null,b(t.form.attachments,a=>(n(),l("div",{key:a,class:"w-10 h-10 rounded-lg overflow-hidden flex items-center justify-center group relative bg-white border"},[i.getFileType(a)==="photo"?(n(),l("img",{key:0,src:t.$file(a),class:"w-full h-full object-cover",alt:""},null,8,je)):(n(),D(u,{key:1,name:"FileCheck",size:16})),s("div",{class:"w-full h-full bg-white/60 absolute top-0 left-0 flex items-center justify-center opacity-0 duration-300 group-hover:opacity-100 cursor-pointer",onClick:e[1]||(e[1]=(...x)=>i.clearAttachments&&i.clearAttachments(...x))},[p(u,{name:"Trash",size:16,class:"text-red-400"})])]))),128))])):f("",!0),s("div",Fe,[F(s("input",{type:"text",class:"input focus:outline-none bg-gray-100 rounded-none w-full h-[50px] pr-15",placeholder:"Ваше сообщение","onUpdate:modelValue":e[2]||(e[2]=a=>t.form.message=a),onKeyup:e[3]||(e[3]=z((...a)=>i.onSubmit&&i.onSubmit(...a),["enter"]))},null,544),[[A,t.form.message]]),s("div",Ae,[s("input",{type:"file",ref:"file",class:"hidden",onChange:e[4]||(e[4]=(...a)=>i.onChangeFile&&i.onChangeFile(...a))},null,544),s("button",{class:"btn border-none bg-white btn-square",onClick:e[5]||(e[5]=(...a)=>i.openFileChange&&i.openFileChange(...a))},[p(u,{name:"Paperclip",size:16})]),s("button",{class:"btn btn-primary btn-square",onClick:e[6]||(e[6]=(...a)=>i.onSubmit&&i.onSubmit(...a))},[p(u,{name:"SendHorizontal",fill:"#ffffff",strokeWidth:0,size:16})])])])])])):f("",!0)]),p(v,{ref:"invoiceDialog",onUpdate:i.onInvoiceUpdate},null,8,["onUpdate"])],64)}const Re=w(se,[["render",De]]),ze={props:["chats"],components:{Sidebar:te,Room:Re},data:()=>({chatService:new $,dialogs:[],room:{loading:null,data:null}}),async created(){var t,e;if(this.dialogs=this.chats,(t=this.$route.query)!=null&&t.customer){const o=this.$route.query.customer;this.dialogs.findIndex(g=>g.customer.id===o)>-1?await this.onChangeRoom((e=this.$route.query)==null?void 0:e.customer):this.$toast.info("Чат с пользователем не найден")}},mounted(){q.on("message",async t=>{this.updateDialog(t.id,t.message),await this.updateRoom(t.customer_id)})},computed:{},methods:{async onChangeRoom(t,e=!0){e&&(this.room.loading=!0);const o=await this.chatService.getByCustomer(t);this.room.data=o,this.room.loading=!1,this.$nextTick(()=>{if(e){const r=document.getElementById("messages");r.scrollTo(0,r.scrollHeight)}else document.querySelector(".last_message").scrollIntoView({behavior:"smooth"})})},async onAdminMessage(t){var i;const e=t.customer,o=t;delete o.customer;const r=await this.chatService.sendMessage(e,o),g=this.chats.findIndex(u=>u.id===r.id);this.dialogs[g].last=r.last,r.id===((i=this.room.data)==null?void 0:i.id)&&(this.room.data=r,this.$nextTick(()=>{document.querySelector(".last_message").scrollIntoView({behavior:"smooth"})}))},updateDialog(t,e){const o=this.dialogs.findIndex(r=>r.id===t);o>-1&&(this.dialogs[o].last=e)},async updateRoom(t){var e;t===((e=this.room.data)==null?void 0:e.customer.id)&&await this.onChangeRoom(t,!1)}}},qe={class:"flex w-full h-full"};function Te(t,e,o,r,g,i){const u=_("Sidebar"),d=_("Room");return n(),l("div",qe,[p(u,{dialogs:t.dialogs,class:"min-w-[340px] max-w-[340px] border-r-[1px]",onRoom:i.onChangeRoom},null,8,["dialogs","onRoom"]),p(d,{class:"w-full",data:t.room.data,loading:t.room.loading},null,8,["data","loading"])])}const Ve=w(ze,[["render",Te]]),Be={components:{ChatLayout:Ve},data:()=>({chatService:new $,chats:[],loading:!0}),created(){this.getAll()},methods:{async getAll(){const t=await this.chatService.getAll();this.chats=t,this.loading=!1}}},Le={key:0,class:"flex justify-center"};function Me(t,e,o,r,g,i){const u=_("ChatLayout");return t.loading?(n(),l("div",Le,e[0]||(e[0]=[s("span",{class:"loading loading-spinner text-primary"},null,-1)]))):(n(),D(u,{key:1,chats:t.chats},null,8,["chats"]))}const Qe=w(Be,[["render",Me]]);export{Qe as default};
